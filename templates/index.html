<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Air Quality Visualizer - Real-time Environmental Monitoring</title>
    <link rel="stylesheet" href="{{ url_for('static', path='/css/style2.css') }}">
    <link rel="icon" href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>üå§Ô∏è</text></svg>">
</head>
<body>
    <header>
        <div class="container">
            <nav>
                <div class="logo">üå§Ô∏è AirViz</div>
                <ul class="nav-links">
                    <li><a href="#home">Home</a></li>
                    <li><a href="#dashboard">Dashboard</a></li>
                    <li><a href="#contact">Contact</a></li>
                </ul>
                <div class="mobile-menu-toggle">‚ò∞</div>
            </nav>
        </div>
    </header>

    <main>
        <section id="home" class="hero">
            <div class="container">
                <h1>Air Quality Visualizer</h1>
                <p>Real-time environmental monitoring with comprehensive air quality index (AQI) tracking and detailed particle level analysis</p>
                
                <div class="location-input">
                    <input type="text" id="locationInput" placeholder="Enter city name (e.g., New York, London, Tokyo)" autocomplete="off">
                    <button id="getDataBtn" onclick="getEnvironmentalData()">
                        <span class="btn-text">Get Environmental Data</span>
                        <span class="btn-loading" style="display: none;">Loading...</span>
                    </button>
                </div>
                
                <div class="error-message" id="errorMessage" style="display: none;"></div>
            </div>
        </section>

        <section class="container" id="dashboard">
            <div class="environmental-dashboard" id="environmentalDashboard" style="display: none;">
                <div class="dashboard-header">
                    <h2>Real-time Environmental Conditions</h2>
                    <div id="locationName" class="location-display"></div>
                    <div id="lastUpdated" class="last-updated"></div>
                    <div id="demoNotice" class="demo-notice" style="display: none;">
                        <span>üß™ Demo Mode - Add your API keys for real data</span>
                    </div>
                </div>
                
                <!-- Weather Data Section -->
                <div class="section-header">
                    <h3>üå§Ô∏è Weather Conditions</h3>
                </div>
                <div class="weather-grid">
                    <div class="weather-card temperature-card">
                        <div class="weather-icon">üå°Ô∏è</div>
                        <div class="weather-value" id="temperature">--¬∞C</div>
                        <div class="weather-label">Temperature</div>
                    </div>
                    
                    <div class="weather-card heat-index-card">
                        <div class="weather-icon">üî•</div>
                        <div class="weather-value" id="heatIndex">--¬∞C</div>
                        <div class="weather-label">Heat Index</div>
                    </div>
                    
                    <div class="weather-card condition-card">
                        <div class="weather-icon" id="conditionIcon">üå§Ô∏è</div>
                        <div class="weather-value" id="condition">--</div>
                        <div class="weather-label">Conditions</div>
                    </div>
                    
                    <div class="weather-card humidity-card">
                        <div class="weather-icon">üíß</div>
                        <div class="weather-value" id="humidity">--%</div>
                        <div class="weather-label">Humidity</div>
                        <div class="humidity-bar">
                            <div class="humidity-fill" id="humidityFill"></div>
                        </div>
                    </div>
                    
                    <div class="weather-card cloud-card">
                        <div class="weather-icon">‚òÅÔ∏è</div>
                        <div class="weather-value" id="cloud">--%</div>
                        <div class="weather-label">Cloud Cover</div>
                        <div class="cloud-bar">
                            <div class="cloud-fill" id="cloudFill"></div>
                        </div>
                    </div>
                    
                    <div class="weather-card uv-card">
                        <div class="weather-icon">‚òÄÔ∏è</div>
                        <div class="weather-value" id="uv">--</div>
                        <div class="weather-label">UV Index</div>
                        <div class="uv-description" id="uvDescription">UV Level</div>
                    </div>
                </div>

                <!-- Air Quality Section -->
                <div class="section-header">
                    <h3>üå¨Ô∏è Air Quality Index (AQI)</h3>
                </div>
                <div class="aqi-overview">
                    <div class="aqi-main-card">
                        <div class="aqi-circle" id="aqiCircle">
                            <div class="aqi-value" id="aqiValue">--</div>
                            <div class="aqi-category" id="aqiCategory">Loading...</div>
                        </div>
                        <div class="aqi-info">
                            <div class="dominant-pollutant">
                                <span class="label">Dominant Pollutant:</span>
                                <span id="dominantPollutant">--</span>
                            </div>
                            <div class="air-quality-updated">
                                <span class="label">Last Updated:</span>
                                <span id="aqiLastUpdated">--</span>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Pollutant Details -->
                <div class="section-header">
                    <h3>üî¨ Pollutant Levels</h3>
                </div>
                <div class="pollutant-grid">
                    <div class="pollutant-card pm25-card">
                        <div class="pollutant-icon">üî¥</div>
                        <div class="pollutant-name">PM2.5</div>
                        <div class="pollutant-value" id="pm25Value">-- Œºg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="pm25AQI">--</span></div>
                        <div class="pollutant-description">Fine particles</div>
                    </div>
                    
                    <div class="pollutant-card pm10-card">
                        <div class="pollutant-icon">üü†</div>
                        <div class="pollutant-name">PM10</div>
                        <div class="pollutant-value" id="pm10Value">-- Œºg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="pm10AQI">--</span></div>
                        <div class="pollutant-description">Coarse particles</div>
                    </div>
                    
                    <div class="pollutant-card ozone-card">
                        <div class="pollutant-icon">üü°</div>
                        <div class="pollutant-name">O‚ÇÉ</div>
                        <div class="pollutant-value" id="ozoneValue">-- Œºg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="ozoneAQI">--</span></div>
                        <div class="pollutant-description">Ground-level ozone</div>
                    </div>
                    
                    <div class="pollutant-card no2-card">
                        <div class="pollutant-icon">üü§</div>
                        <div class="pollutant-name">NO‚ÇÇ</div>
                        <div class="pollutant-value" id="no2Value">-- Œºg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="no2AQI">--</span></div>
                        <div class="pollutant-description">Nitrogen dioxide</div>
                    </div>
                    
                    <div class="pollutant-card so2-card">
                        <div class="pollutant-icon">üü£</div>
                        <div class="pollutant-name">SO‚ÇÇ</div>
                        <div class="pollutant-value" id="so2Value">-- Œºg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="so2AQI">--</span></div>
                        <div class="pollutant-description">Sulfur dioxide</div>
                    </div>
                    
                    <div class="pollutant-card co-card">
                        <div class="pollutant-icon">‚ö´</div>
                        <div class="pollutant-name">CO</div>
                        <div class="pollutant-value" id="coValue">-- mg/m¬≥</div>
                        <div class="pollutant-aqi">AQI: <span id="coAQI">--</span></div>
                        <div class="pollutant-description">Carbon monoxide</div>
                    </div>
                </div>
            </div>
        </section>
    </main>

    <footer>
        <div class="container">
            <p>&copy; 2024 Air Quality Visualizer. Built with ‚ù§Ô∏è for environmental awareness.</p>
        </div>
    </footer>

    <script>
        // API configuration
        const API_BASE_URL = '';  // FastAPI will serve from same origin

        // Environmental data fetching
        async function getEnvironmentalData() {
            const location = document.getElementById('locationInput').value.trim();
            
            if (!location) {
                showError('Please enter a city name');
                return;
            }

            // Show loading state
            setLoadingState(true);
            hideError();

            try {
                // Fetch both weather and AQI data simultaneously
                const [weatherResponse, aqiResponse] = await Promise.all([
                    fetch(`${API_BASE_URL}/api/weather/${encodeURIComponent(location)}`),
                    fetch(`${API_BASE_URL}/api/aqi/${encodeURIComponent(location)}`)
                ]);

                let weatherData = null;
                let aqiData = null;

                // Handle weather data
                if (weatherResponse.ok) {
                    weatherData = await weatherResponse.json();
                }

                // Handle AQI data
                if (aqiResponse.ok) {
                    aqiData = await aqiResponse.json();
                }

                // Display the data if at least one API returned valid data
                if (weatherData || aqiData) {
                    displayEnvironmentalData(weatherData, aqiData);
                } else {
                    throw new Error('Unable to fetch environmental data for this location');
                }
                
            } catch (error) {
                console.error('Error fetching environmental data:', error);
                showError('Unable to fetch environmental data. Please check the city name and try again.');
            } finally {
                setLoadingState(false);
            }
        }

        function displayEnvironmentalData(weatherData, aqiData) {
            const dashboard = document.getElementById('environmentalDashboard');
            
            // Determine if we're in demo mode
            const isDemoMode = (weatherData?.is_demo) || (aqiData?.is_demo);
            
            // Show demo notice if using demo data
            const demoNotice = document.getElementById('demoNotice');
            demoNotice.style.display = isDemoMode ? 'block' : 'none';

            // Update location info
            if (weatherData?.location) {
                document.getElementById('locationName').textContent = 
                    `${weatherData.location.name}, ${weatherData.location.country}`;
            } else if (aqiData?.stations?.[0]) {
                document.getElementById('locationName').textContent = 
                    `${aqiData.stations[0].city}, ${aqiData.stations[0].state}`;
            }

            // Display weather data
            if (weatherData?.current) {
                displayWeatherData(weatherData);
            }

            // Display AQI data
            if (aqiData?.stations?.[0]) {
                displayAQIData(aqiData.stations[0]);
            }

            // Show dashboard
            dashboard.style.display = 'block';
            dashboard.scrollIntoView({ behavior: 'smooth' });
        }

        function displayWeatherData(data) {
            if (data.current.last_updated) {
                document.getElementById('lastUpdated').textContent = 
                    `Weather updated: ${new Date(data.current.last_updated).toLocaleString()}`;
            }
            
            // Update weather values
            document.getElementById('temperature').textContent = `${data.current.temp_c}¬∞C`;
            document.getElementById('heatIndex').textContent = `${data.current.heatindex_c}¬∞C`;
            document.getElementById('condition').textContent = data.current.condition.text;
            document.getElementById('humidity').textContent = `${data.current.humidity}%`;
            document.getElementById('cloud').textContent = `${data.current.cloud}%`;
            document.getElementById('uv').textContent = data.current.uv;

            // Update visual elements
            updateHumidityBar(data.current.humidity);
            updateCloudBar(data.current.cloud);
            updateUVDescription(data.current.uv);
            updateConditionIcon(data.current.condition.text);
        }

        function displayAQIData(station) {
            // Update main AQI display
            const aqiValue = station.AQI || 0;
            document.getElementById('aqiValue').textContent = aqiValue;
            
            // Update AQI category and circle color
            const category = getAQICategory(aqiValue);
            document.getElementById('aqiCategory').textContent = category.text;
            document.getElementById('aqiCircle').className = `aqi-circle ${category.class}`;

            // Update dominant pollutant
            if (station.aqiInfo?.pollutant) {
                document.getElementById('dominantPollutant').textContent = station.aqiInfo.pollutant;
            }

            // Update last updated time
            if (station.updatedAt) {
                document.getElementById('aqiLastUpdated').textContent = 
                    new Date(station.updatedAt).toLocaleString();
            }

            // Update individual pollutant values
            updatePollutantValue('pm25', station.PM25);
            updatePollutantValue('pm10', station.PM10);
            updatePollutantValue('ozone', station.OZONE);
            updatePollutantValue('no2', station.NO2);
            updatePollutantValue('so2', station.SO2);
            updatePollutantValue('co', station.CO);
        }

        function updatePollutantValue(pollutant, data) {
            if (data) {
                const valueElement = document.getElementById(`${pollutant}Value`);
                const aqiElement = document.getElementById(`${pollutant}AQI`);
                
                if (valueElement && aqiElement) {
                    // CO is typically in mg/m¬≥, others in Œºg/m¬≥
                    const unit = pollutant === 'co' ? 'mg/m¬≥' : 'Œºg/m¬≥';
                    valueElement.textContent = `${data.concentration || 0} ${unit}`;
                    aqiElement.textContent = data.AQI || 0;
                    
                    // Update card color based on AQI
                    const card = valueElement.closest('.pollutant-card');
                    if (card) {
                        const category = getAQICategory(data.AQI || 0);
                        card.className = `pollutant-card ${pollutant}-card ${category.class}`;
                    }
                }
            }
        }

        function getAQICategory(aqi) {
            if (aqi <= 50) {
                return { text: 'Good', class: 'good' };
            } else if (aqi <= 100) {
                return { text: 'Moderate', class: 'moderate' };
            } else if (aqi <= 150) {
                return { text: 'Unhealthy for Sensitive', class: 'unhealthy-sensitive' };
            } else if (aqi <= 200) {
                return { text: 'Unhealthy', class: 'unhealthy' };
            } else if (aqi <= 300) {
                return { text: 'Very Unhealthy', class: 'very-unhealthy' };
            } else {
                return { text: 'Hazardous', class: 'hazardous' };
            }
        }

        function updateHumidityBar(humidity) {
            const fill = document.getElementById('humidityFill');
            if (fill) fill.style.width = `${humidity}%`;
        }

        function updateCloudBar(cloud) {
            const fill = document.getElementById('cloudFill');
            if (fill) fill.style.width = `${cloud}%`;
        }

        function updateUVDescription(uv) {
            const description = document.getElementById('uvDescription');
            if (description) {
                if (uv <= 2) description.textContent = 'Low';
                else if (uv <= 5) description.textContent = 'Moderate';
                else if (uv <= 7) description.textContent = 'High';
                else if (uv <= 10) description.textContent = 'Very High';
                else description.textContent = 'Extreme';
            }
        }

        function updateConditionIcon(condition) {
            const icon = document.getElementById('conditionIcon');
            if (icon) {
                const conditionLower = condition.toLowerCase();
                
                if (conditionLower.includes('sunny') || conditionLower.includes('clear')) {
                    icon.textContent = '‚òÄÔ∏è';
                } else if (conditionLower.includes('cloud')) {
                    icon.textContent = '‚òÅÔ∏è';
                } else if (conditionLower.includes('rain')) {
                    icon.textContent = 'üåßÔ∏è';
                } else if (conditionLower.includes('snow')) {
                    icon.textContent = '‚ùÑÔ∏è';
                } else if (conditionLower.includes('storm')) {
                    icon.textContent = '‚õàÔ∏è';
                } else {
                    icon.textContent = 'üå§Ô∏è';
                }
            }
        }

        function setLoadingState(loading) {
            const button = document.getElementById('getDataBtn');
            const btnText = button.querySelector('.btn-text');
            const btnLoading = button.querySelector('.btn-loading');
            
            if (loading) {
                btnText.style.display = 'none';
                btnLoading.style.display = 'inline';
                button.disabled = true;
            } else {
                btnText.style.display = 'inline';
                btnLoading.style.display = 'none';
                button.disabled = false;
            }
        }

        function showError(message) {
            const errorElement = document.getElementById('errorMessage');
            errorElement.textContent = message;
            errorElement.style.display = 'block';
            setTimeout(hideError, 5000);  // Auto-hide after 5 seconds
        }

        function hideError() {
            document.getElementById('errorMessage').style.display = 'none';
        }

        // Event listeners
        document.getElementById('locationInput').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                getEnvironmentalData();
            }
        });

        // Smooth scrolling for navigation
        document.querySelectorAll('a[href^="#"]').forEach(anchor => {
            anchor.addEventListener('click', function (e) {
                e.preventDefault();
                const target = document.querySelector(this.getAttribute('href'));
                if (target) {
                    target.scrollIntoView({
                        behavior: 'smooth',
                        block: 'start'
                    });
                }
            });
        });

        // Mobile menu toggle
        document.querySelector('.mobile-menu-toggle').addEventListener('click', function() {
            document.querySelector('.nav-links').classList.toggle('active');
        });
    </script>
</body>
</html>